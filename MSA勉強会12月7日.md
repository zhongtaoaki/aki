# MSAデザインパターン

- 日時：2019年10月30日 水曜日
- 場所：ソフトシンク新宿事業所
- 講師：大塚さん

今日から、分散システムのデザインパターンを勉強しようと思う。
今回はその中で分散システムでのトランザクションを解説された。


****

## トランザクションそのもの

### トランザクションとは

「トランザクション」とは複数の処理を1つにまとめたもの。
- 業務トランザクション観点には、業務の一連の流れを単位にまとめを意味する。
- DBを話す時は、複数の SQL 文によるデータ更新を1つの処理としてまとめてデータベースに反映させることと意味する。

そこで、もっとも重要なのは、トランザクションの途中でエラーが発生した場合の処理。

### ACID
トランザクション処理の信頼性を保証するために、何か求められるというと、ACIDの性質である。
- A:
  - Atomicity(原子性)：一連のSQLの間に、処理の全部完成されるか、あるいは全く開始していないことを保証する。
- C:
  - Consistency(整合性)：トランザクション開始と終了時にあらかじめ与えられた整合性を満たすことを保証する。
- I: 
  - Isolation(分離性)：複数スレッドで、相手のトランザクションは自分に影響を及ぼさないこと、排他制御する。
- D: 
  - Durability(永続性)：トランザクション終わったらその操作は消えないように残るようにする

## 分散システムにはトランザクションがどうなるか


分散システムで、一個のサービス単位はアプリケーションと操作するデータベースの組み合わせであり、そのサービスの内部には、トランザクション処理のACID性質を求められる。

但し、マイクロサービスでは複数のAPIでのやり取りとなるため、システム全体的にACIDは崩れる。
- Atomicity(原子性)：障害があったらもちろん保証できないが、複数のサービスあるので障害の発生率が高まると考えられる。
- Consistency(整合性)：そもそも分散システムは整合しないように設計されたもの。
- Isolation(分離性)：他のサービスにやり取りとなるので、影響がないわけがない。
- Durability(永続性)：実現できるが、ログ収集として別の話題になる。

というわけで、ACIDを求めるという考え方は分散システムで納得できない。
では、何か求めるというと、CAP定理を登場した。

CAP定理：分散システムは「CAP」の3つの保証のうち、同時に2つの保証を満たすことはできるが、同時に全てを満たすことはできない。

- C:
  - Consistency(整合性)：トランザクション開始と終了時にあらかじめ与えられた整合性を満たすことを保証する。
- A:
  - Availability(可用性)：ノードの障害があっても、ノードの機能は継続的に動く。
- P:
  - Partytion tolerance(分断耐性)：システムは任意の通信障害などによるメッセージ損失に対し、継続して動作を行う。

そこで、CAP定理の進化もあり：二つしか保証できないではなくて、三つの保証をバランスをとって、それぞれ強まるか弱まるかと考えられる。

## 分散システムにの解決策

分散システムで、トランザクションも分散しているわけで、CAP定理を考えながら設計するのは大事である。
しかも、分散トランザクションは、複雑で不具合の原因になる可能性が高いため。マイクロサービスアーキテクチャで推奨しているのは、分散トランザクションではなく、複数リソースの結果整合性を優先的に考える。

- 処理順番を考えよう

例え、三つの処理があって、一番重要な処理を処理順番を優先にする。順番変わると、ロールバックの数を少なくする、システムの分断耐性が高まれる。

- 業務処理を調整する

普段のアーキテクチャは業務を変えられない前提として行っている。
しかも、分散システムで業務をちょっと工夫するとシステムはそんなに複雑にするまでもない場合、業務を調整するのも考えの一つ。

- 可換性を考えよう

つまり入っている順番を入れ替わっても最終的な結果はかわらない
例え、DBの処理は更新ではなくてインサートする、インサートの履歴を管理して、後回しに処理する。

- SAGAを考えよう

SAGAパターンは、ロールバックを行うことができない代わりに、補償という考え方を提供している。ロールバックを行うことができないので、代わりにインタラクションの操作を逆向きにした取り消し操作により、擬似的なロールバックを行う。
